# Deploys an opinionated terraform project to an azure subscription

# Requirements (create using ./az-setup.sh)
# ${{ parameters.environment }} pipeline parameter
# service connection created in Azure Devops
# azure storage account for backend

# Assumes a folder structure:
# tf-envs/
# ├── ${{ parameters.environment }}/
# │   ├── main.tf
# │   ├── variables.tf
# ├── tfvars/
# │   ├── ${{ parameters.environment }}.tfvars

parameters:
- name: environment
  type: string
  default: 'dev'
- name: umbracoSemanticVersion
  type: string
  default: '8.6.0'
- name: umbracoInstanceName
  type: string
  default: 'dev-test-random-mto'

variables:
- name: serviceConnectionName
  value: 'tf-sp-dev-mto-test'
- name:  tfvarsFile
  value: ${{ parameters.environment }}.tfvars
- name: tfBackendResourceGroupName
  value: rg-tf-backend-storage
- name: tfBackendStorageAccountName
  value: sttfbackend34587
- name:  tfBackendStorageContainerName
  value: tf-backend-files
- name:  tfBackendFileName  
  value: ${{ parameters.environment }}-tf-state-file

trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

steps:
#PARAMETER VALIDATION
- script: |
    set +e
    if [ -z ${{ parameters.environment }} ]; then
    echo "target environment not specified";
    exit 1;
    fi
    echo "environment is:" ${{ parameters.environment }}
  displayName: 'Validate parameters'

#TERRAFORM INIT, PLAN & APPLY
- task: AzureCLI@2
  inputs:
    azureSubscription: '$(serviceConnectionName)'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      echo '#######Setting Azure Service Principal Environment Variables########'
      export ARM_CLIENT_ID=$servicePrincipalId
      export ARM_CLIENT_SECRET=$servicePrincipalKey
      export ARM_SUBSCRIPTION_ID=$(az account show | jq '.id' -r)
      export ARM_TENANT_ID=$tenantId

      echo '#######Terraform Init########'
      terraform init -backend-config="resource_group_name=$(tfBackendResourceGroupName)" -backend-config="storage_account_name=$(tfBackendStorageAccountName)" -backend-config="container_name=$(tfBackendStorageContainerName)" -backend-config="key=$(tfBackendFileName)"  
    
      echo '#######Terraform Plan########'
      terraform plan -var-file=../tf-vars/$(tfvarsFile) \
        -out="out.plan" \
        -var='package_source_url=http://umbracoreleases.blob.core.windows.net/download/UmbracoCms.${{ parameters.umbracoSemanticVersion }}.zip' \
        -var='instance_id=${{ parameters.umbracoInstanceName }}'    
    
      echo '#######Terraform Apply########'
      terraform apply out.plan 
    addSpnToEnvironment: true
    workingDirectory: '$(System.DefaultWorkingDirectory)/tf-envs/${{ parameters.environment }}'
  displayName: 'Terraform apply'
